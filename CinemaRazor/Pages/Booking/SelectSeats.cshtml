@page
@model CinemaRazor.Pages.Booking.SelectSeatsModel

@{
    ViewData["Title"] = "Выбор места";
}

<section class="page-header mb-4">
    <h1 class="page-title">@Model.Session.Movie.Title</h1>
    <p class="page-subtitle">
        <strong>Сеанс:</strong> @Model.Session.StartTime.ToString("dd.MM.yyyy HH:mm") | 
        <strong>Цена:</strong> @Model.Session.Price.ToString("0") BYN
    </p>
</section>

<div class="mb-4">
    <h4 class="mb-3">Легенда мест:</h4>
    <div class="d-flex gap-4 mb-4 flex-wrap">
        <div class="legend-item">
            <span class="seat-circle available"></span>
            <span>Свободно</span>
        </div>
        <div class="legend-item">
            <span class="seat-circle occupied"></span>
            <span>Занято</span>
        </div>
        <div class="legend-item">
            <span class="seat-circle selected"></span>
            <span>Выбрано</span>
        </div>
    </div>
</div>

<div class="cinema-screen mb-4">
    <div class="screen-label">ЭКРАН</div>
</div>

<div class="seats-container">
    @for (int row = 1; row <= Model.MaxRow; row++)
    {
        <div class="seat-row">
            <div class="row-label">Ряд @row</div>
            <div class="seats">
                @for (int seatNum = 1; seatNum <= Model.MaxSeatInRow; seatNum++)
                {
                    var seat = Model.AllSeats.FirstOrDefault(s => s.RowNumber == row && s.SeatNumber == seatNum);
                    if (seat != null)
                    {
                        var isOccupied = Model.OccupiedSeatIds.Contains(seat.Id);
                        var seatClass = isOccupied ? "occupied" : "available";
                        
                        <button type="button" 
                                class="seat-circle @seatClass" 
                                data-seat-id="@seat.Id"
                                data-row="@row"
                                data-seat="@seatNum"
                                @(isOccupied ? "disabled" : "")
                                onclick="selectSeat(this)">
                            @seatNum
                        </button>
                    }
                    else
                    {
                        <div class="seat-circle invisible">-</div>
                    }
                }
            </div>
        </div>
    }
</div>

<div class="mt-4">
    <div class="surface-card surface-card--loose details-container">
        <h5 class="mb-3">Выбранное место:</h5>
        <p id="selected-info" class="text-muted mb-4">Место не выбрано</p>
        <form method="post">
            <input type="hidden" name="SessionId" value="@Model.Session.Id" />
            <input type="hidden" name="SeatId" id="selected-seat-id" value="" />
            <div class="d-flex gap-2 flex-wrap">
                <button type="submit" id="book-btn" class="btn btn-primary" disabled>
                    Забронировать место
                </button>
                <a asp-page="./Index" class="btn btn-outline-secondary">Отмена</a>
            </div>
        </form>
    </div>
</div>

<script>
    let selectedSeatId = null;

    function selectSeat(button) {
        // Снять выделение с предыдущего места
        document.querySelectorAll('.seat-circle.selected').forEach(seat => {
            seat.classList.remove('selected');
            seat.classList.add('available');
        });

        // Выделить новое место
        button.classList.remove('available');
        button.classList.add('selected');

        selectedSeatId = button.getAttribute('data-seat-id');
        const row = button.getAttribute('data-row');
        const seat = button.getAttribute('data-seat');

        // Обновить информацию о выбранном месте
        document.getElementById('selected-info').innerText = `Ряд ${row}, Место ${seat}`;
        document.getElementById('selected-seat-id').value = selectedSeatId;
        document.getElementById('book-btn').disabled = false;
    }
</script>
