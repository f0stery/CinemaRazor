@page
@model CinemaRazor.Pages.Tickets.CreateModel

@{
    ViewData["Title"] = "Продажа билета";
}

<section class="page-header mb-4">
    <h1 class="page-title">Продажа билета</h1>
    <p class="page-subtitle">Выберите фильм и сеанс, затем отметьте свободное место, чтобы оформить билет для зрителя.</p>
</section>

@if (!Model.HasAnySessions)
{
    <div class="surface-card surface-card--loose support-card">
        <h2>Нет доступных сеансов</h2>
        <p>Запланируйте хотя бы один сеанс, чтобы начать продажу билетов.</p>
        <div class="d-flex flex-wrap gap-2">
            <a asp-page="/Sessions/Create" class="btn btn-primary">Создать сеанс</a>
            <a asp-page="/Sessions/Index" class="btn btn-outline-secondary">Перейти к расписанию</a>
        </div>
    </div>
}
else
{
    <div class="surface-card surface-card--loose mb-4">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-12 col-md-8">
                <label asp-for="MovieId" class="form-label">Фильм</label>
                <select asp-for="MovieId" class="form-select" asp-items="Model.MovieOptions" onchange="this.form.submit()">
                    <option value="">Выберите фильм</option>
                </select>
            </div>
            <div class="col-12 col-md-4 d-flex justify-content-md-end gap-2">
                <a asp-page="Index" class="btn btn-outline-secondary mt-3 mt-md-0">К списку билетов</a>
                <a asp-page="/Sessions/Create" class="btn btn-outline-primary mt-3 mt-md-0">Новый сеанс</a>
            </div>
        </form>
    </div>

    if (!Model.MovieId.HasValue)
    {
        <div class="surface-card surface-card--loose support-card">
            <h2>Выберите фильм</h2>
            <p>Чтобы продолжить продажу билетов, сначала выберите фильм с запланированными сеансами.</p>
        </div>
    }
    else if (!Model.HasSessionsForSelectedMovie)
    {
        <div class="surface-card surface-card--loose support-card">
            <h2>Для выбранного фильма нет сеансов</h2>
            <p>Добавьте расписание для фильма, чтобы оформить продажу билета.</p>
            <a asp-page="/Sessions/Create" asp-route-movieId="@Model.MovieId" class="btn btn-primary">Запланировать сеанс</a>
        </div>
    }
    else
    {
        <div class="surface-card surface-card--loose mb-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
                <div>
                    <h2 class="h5 mb-1">Сеансы фильма</h2>
                    <div class="text-muted small">Нажмите на сеанс, чтобы выбрать место и оформить билет.</div>
                </div>
                <span class="badge bg-light text-dark">Доступно: @Model.MovieSessions.Count</span>
            </div>

            <div class="session-selector">
                @foreach (var option in Model.MovieSessions)
                {
                    var isSelected = Model.Session != null && option.Id == Model.Session.Id;
                    DateTime? endTime = option.EndTime > option.StartTime ? option.EndTime : (DateTime?)null;

                    <a asp-page="Create"
                       asp-route-MovieId="@Model.MovieId"
                       asp-route-SessionId="@option.Id"
                       class="session-selector__item @(isSelected ? "session-selector__item--active" : string.Empty)">
                        <div>
                            <div class="fw-semibold">@option.StartTime.ToString("dd.MM.yyyy HH:mm")</div>
                            <div class="session-selector__meta">
                                Окончание: @(endTime.HasValue ? endTime.Value.ToString("dd.MM.yyyy HH:mm") : "—")
                            </div>
                        </div>
                        <div class="session-selector__stats">
                            <span class="session-selector__badge">@option.Price.ToString("0") BYN</span>
                            <span class="session-selector__badge session-selector__badge--muted">Свободно: @option.SeatsAvailable</span>
                        </div>
                    </a>
                }
            </div>
        </div>
    }

    if (Model.Session == null)
    {
        if (Model.MovieId.HasValue && Model.HasSessionsForSelectedMovie)
        {
            <div class="surface-card surface-card--loose support-card">
                <h2>Выберите сеанс</h2>
                <p>Нажмите на интересующий сеанс, чтобы увидеть схему зала и выбрать свободное место.</p>
            </div>
        }
    }
    else
    {
        <div class="surface-card surface-card--loose hall-layout">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                <div>
                    <h2 class="h4 mb-1">@Model.Session.Movie?.Title</h2>
                    <div class="text-muted small">
                        Начало: @Model.Session.StartTime.ToString("dd.MM.yyyy HH:mm")<br />
                        @{
                            DateTime? endTime = Model.Session.EndTime > Model.Session.StartTime
                            ? Model.Session.EndTime
                            : (DateTime?)null;
                        }
                        Окончание: @(endTime.HasValue ? endTime.Value.ToString("dd.MM.yyyy HH:mm") : "—")
                    </div>
                </div>
                <div class="text-end">
                    <div class="text-muted small">Цена билета</div>
                    <span class="price-badge">@Model.Session.Price.ToString("0") BYN</span>
                </div>
            </div>

            <form method="post" id="sellTicketForm" class="d-flex flex-column gap-4">
                @Html.AntiForgeryToken()
                <input asp-for="MovieId" type="hidden" />
                <input asp-for="SessionId" type="hidden" />
                <input asp-for="SelectedSeatId" type="hidden" id="selected-seat-id" />

                <div asp-validation-summary="All" class="text-danger"></div>

                <div class="hall-legend">
                    <div class="legend-item">
                        <span class="seat-circle available"></span>
                        <span>Свободно</span>
                    </div>
                    <div class="legend-item">
                        <span class="seat-circle occupied"></span>
                        <span>Занято</span>
                    </div>
                    <div class="legend-item">
                        <span class="seat-circle selected"></span>
                        <span>Выбрано</span>
                    </div>
                </div>

                @if (Model.SeatLayout.Any())
                {
                    var maxRow = Model.SeatLayout.Max(s => s.RowNumber);
                    var maxSeat = Model.SeatLayout.Max(s => s.SeatNumber);

                    <div class="cinema-screen">
                        <div class="screen-label">Экран</div>
                    </div>

                    <div class="seats-container">
                        @for (var row = 1; row <= maxRow; row++)
                        {
                            var rowSeats = Model.SeatLayout.Where(s => s.RowNumber == row).OrderBy(s => s.SeatNumber).ToList();
                            <div class="seat-row">
                                <div class="row-label">Ряд @row</div>
                                <div class="seats">
                                    @for (var seatNumber = 1; seatNumber <= maxSeat; seatNumber++)
                                    {
                                        var seat = rowSeats.FirstOrDefault(s => s.SeatNumber == seatNumber);
                                        if (seat != null)
                                        {
                                            var isSelected = Model.SelectedSeatId.HasValue && seat.SeatId == Model.SelectedSeatId.Value;
                                            var seatClasses = seat.IsOccupied ? "seat-circle occupied" : "seat-circle available";
                                            if (isSelected && !seat.IsOccupied)
                                            {
                                                seatClasses += " selected";
                                            }

                                            if (seat.IsOccupied)
                                            {
                                                <button type="button"
                                                        class="@seatClasses"
                                                        title="Ряд @seat.RowNumber, место @seat.SeatNumber"
                                                        disabled>
                                                    @seat.SeatNumber
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button"
                                                        class="@seatClasses"
                                                        data-seat-id="@seat.SeatId"
                                                        data-row="@seat.RowNumber"
                                                        data-seat="@seat.SeatNumber"
                                                        title="Ряд @seat.RowNumber, место @seat.SeatNumber">
                                                    @seat.SeatNumber
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            <div class="seat-circle invisible">-</div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    var selectedSeat = Model.SelectedSeatId.HasValue
                    ? Model.SeatLayout.FirstOrDefault(s => s.SeatId == Model.SelectedSeatId.Value)
                    : null;

                    <p id="selected-info" class="seat-selection-summary">
                        @(selectedSeat != null
                            ? $"Выбрано место: ряд {selectedSeat.RowNumber}, место {selectedSeat.SeatNumber}"
                            : "Место не выбрано")
                    </p>

                    <div class="seat-actions d-flex gap-2 justify-content-center">
                        <button type="submit" id="sellTicketButton" class="btn btn-primary" disabled>Продать билет</button>
                        <a asp-page="Index" class="btn btn-outline-secondary">Отмена</a>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        Для этого сеанса ещё не настроены места. Настройте схему зала перед продажей билетов.
                    </div>
                }
            </form>
        </div>
    }
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('sellTicketForm');
            if (!form) return;

            const seatButtons = Array.from(form.querySelectorAll('[data-seat-id]'));
            const selectedInput = document.getElementById('selected-seat-id');
            const submitButton = document.getElementById('sellTicketButton');
            const selectedInfo = document.getElementById('selected-info');

            const updateSummary = (row, seat) => {
                if (!selectedInfo) return;
                selectedInfo.textContent = row && seat
                    ? `Выбрано место: ряд ${row}, место ${seat}`
                    : 'Место не выбрано';
            };

            const clearSelection = () => {
                seatButtons.forEach(btn => btn.classList.remove('selected'));
                selectedInput.value = '';
                submitButton.disabled = true;
                updateSummary(null, null);
            };

            const applySelection = (button) => {
                seatButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedInput.value = button.dataset.seatId;
                submitButton.disabled = false;
                updateSummary(button.dataset.row, button.dataset.seat);
            };

            seatButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.disabled) return;
                    applySelection(button);
                });
            });

            const preselected = seatButtons.find(btn => btn.classList.contains('selected'));
            if (preselected) {
                applySelection(preselected);
            } else {
                clearSelection();
            }
        });
    </script>
}
