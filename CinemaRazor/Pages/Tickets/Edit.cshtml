@page "{id:int}"
@model CinemaRazor.Pages.Tickets.EditModel

@{
    ViewData["Title"] = "Изменение билета";
}

<section class="page-header mb-4">
    <h1 class="page-title">Изменение билета</h1>
    <p class="page-subtitle">Переназначьте билет на другой сеанс или свободное место, сохранив актуальную информацию о продаже.</p>
</section>

@if (Model.Ticket == null)
{
    <div class="alert alert-danger">
        Билет не найден. Возможно, он был удалён.
        <div class="mt-3">
            <a asp-page="Index" class="btn btn-outline-secondary">Вернуться к списку билетов</a>
        </div>
    </div>
}
else
{
    <div class="surface-card surface-card--loose details-container mb-4">
        <div class="details-header">
            <h2 class="details-title">@Model.Ticket.Session.Movie.Title</h2>
            <p class="details-subtitle">Билет №@Model.Ticket.Id, оформлен @Model.Ticket.PurchaseDate.ToString("dd.MM.yyyy HH:mm")</p>
        </div>

        <div class="details-row">
            <div class="details-label">Текущий сеанс</div>
            <div class="details-value">
                @Model.Ticket.Session.StartTime.ToString("dd.MM.yyyy HH:mm")
            </div>
        </div>

        <div class="details-row">
            <div class="details-label">Текущее место</div>
            <div class="details-value">
                Ряд @Model.Ticket.Seat.RowNumber, место @Model.Ticket.Seat.SeatNumber
            </div>
        </div>

        <div class="details-row">
            <div class="details-label">Стоимость</div>
            <div class="details-value">
                <span class="price-badge">@Model.Ticket.Price.ToString("0") BYN</span>
            </div>
        </div>

        <div class="details-actions">
            <a asp-page="./Details" asp-route-id="@Model.Ticket.Id" class="btn btn-outline-secondary">Карточка билета</a>
            <a asp-page="Index" class="btn btn-outline-secondary">К списку билетов</a>
        </div>
    </div>

    if (!Model.HasSessionsForMovie)
    {
        <div class="surface-card surface-card--loose support-card">
            <h2>Нет доступных сеансов для фильма</h2>
            <p>Запланируйте дополнительные сеансы, чтобы перенести билет на другую дату.</p>
            <a asp-page="/Sessions/Create" class="btn btn-primary">Создать сеанс</a>
        </div>
    }
    else
    {
        <div class="surface-card surface-card--loose mb-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
                <div>
                    <h2 class="h5 mb-1">Выбор сеанса</h2>
                    <div class="text-muted small">Выберите доступный сеанс, чтобы переназначить билет.</div>
                </div>
                <span class="badge bg-light text-dark">Сеансов: @Model.MovieSessions.Count</span>
            </div>

            <div class="session-selector">
                @foreach (var option in Model.MovieSessions)
                {
                    var isSelected = Model.Session != null && option.Id == Model.Session.Id;
                    DateTime? endTime = option.EndTime > option.StartTime ? option.EndTime : (DateTime?)null;

                    <a asp-page="Edit"
                       asp-route-id="@Model.TicketId"
                       asp-route-sessionId="@option.Id"
                       class="session-selector__item @(isSelected ? "session-selector__item--active" : string.Empty)">
                        <div>
                            <div class="fw-semibold">@option.StartTime.ToString("dd.MM.yyyy HH:mm")</div>
                            <div class="session-selector__meta">
                                Окончание: @(endTime.HasValue ? endTime.Value.ToString("dd.MM.yyyy HH:mm") : "—")
                            </div>
                        </div>
                        <div class="session-selector__stats">
                            <span class="session-selector__badge">@option.Price.ToString("0") BYN</span>
                            <span class="session-selector__badge session-selector__badge--muted">Свободно: @option.SeatsAvailable</span>
                        </div>
                    </a>
                }
            </div>
        </div>
    }

    if (Model.Session == null)
    {
        if (Model.HasSessionsForMovie)
        {
            <div class="surface-card surface-card--loose support-card">
                <h2>Выберите сеанс для переназначения</h2>
                <p>Нажмите на подходящий сеанс, чтобы увидеть схему зала и выбрать новое место.</p>
            </div>
        }
    }
    else
    {
        <div class="surface-card surface-card--loose hall-layout">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                <div>
                    <h2 class="h4 mb-1">@Model.Session.Movie?.Title</h2>
                    <div class="text-muted small">
                        Начало: @Model.Session.StartTime.ToString("dd.MM.yyyy HH:mm")<br />
                        @{
                            DateTime? endTime = Model.Session.EndTime > Model.Session.StartTime
                                ? Model.Session.EndTime
                                : (DateTime?)null;
                        }
                        Окончание: @(endTime.HasValue ? endTime.Value.ToString("dd.MM.yyyy HH:mm") : "—")
                    </div>
                </div>
                <div class="text-end">
                    <div class="text-muted small">Цена сеанса</div>
                    <span class="price-badge">@Model.Session.Price.ToString("0") BYN</span>
                </div>
            </div>

            <form method="post" id="updateTicketForm" class="d-flex flex-column gap-4">
                @Html.AntiForgeryToken()
                <input asp-for="TicketId" type="hidden" />
                <input asp-for="SessionId" type="hidden" />
                <input asp-for="SelectedSeatId" type="hidden" id="selected-seat-id" />

                <div asp-validation-summary="All" class="text-danger"></div>

                <div class="hall-legend">
                    <div class="legend-item">
                        <span class="seat-circle available"></span>
                        <span>Свободно</span>
                    </div>
                    <div class="legend-item">
                        <span class="seat-circle occupied"></span>
                        <span>Занято</span>
                    </div>
                    <div class="legend-item">
                        <span class="seat-circle selected"></span>
                        <span>Выбрано</span>
                    </div>
                </div>

                @if (Model.SeatLayout.Any())
                {
                    var maxRow = Model.SeatLayout.Max(s => s.RowNumber);
                    var maxSeat = Model.SeatLayout.Max(s => s.SeatNumber);

                    <div class="cinema-screen">
                        <div class="screen-label">Экран</div>
                    </div>

                    <div class="seats-container">
                        @for (var row = 1; row <= maxRow; row++)
                        {
                            var rowSeats = Model.SeatLayout.Where(s => s.RowNumber == row).OrderBy(s => s.SeatNumber).ToList();
                            <div class="seat-row">
                                <div class="row-label">Ряд @row</div>
                                <div class="seats">
                                    @for (var seatNumber = 1; seatNumber <= maxSeat; seatNumber++)
                                    {
                                        var seat = rowSeats.FirstOrDefault(s => s.SeatNumber == seatNumber);
                                        if (seat != null)
                                        {
                                            var isSelected = Model.SelectedSeatId.HasValue && seat.SeatId == Model.SelectedSeatId.Value;
                                            var seatClasses = seat.IsOccupied ? "seat-circle occupied" : "seat-circle available";
                                            if (isSelected && !seat.IsOccupied)
                                            {
                                                seatClasses += " selected";
                                            }

                                            if (seat.IsOccupied)
                                            {
                                                <button type="button"
                                                        class="@seatClasses"
                                                        title="Ряд @seat.RowNumber, место @seat.SeatNumber"
                                                        disabled>
                                                    @seat.SeatNumber
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button"
                                                        class="@seatClasses"
                                                        data-seat-id="@seat.SeatId"
                                                        data-row="@seat.RowNumber"
                                                        data-seat="@seat.SeatNumber"
                                                        title="Ряд @seat.RowNumber, место @seat.SeatNumber">
                                                    @seat.SeatNumber
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            <div class="seat-circle invisible">-</div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>

                                            var selectedSeat = Model.SelectedSeatId.HasValue
                            ? Model.SeatLayout.FirstOrDefault(s => s.SeatId == Model.SelectedSeatId.Value)
                            : null;
                                        <p id="selected-info" class="seat-selection-summary">
                        @(selectedSeat != null
                            ? $"Выбрано место: ряд {selectedSeat.RowNumber}, место {selectedSeat.SeatNumber}"
                            : "Место не выбрано")
                    </p>

                    <div class="seat-actions">
                        <button type="submit" id="updateTicketButton" class="btn btn-primary" disabled>Сохранить изменения</button>
                        <a asp-page="Index" class="btn btn-outline-secondary">Отмена</a>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        Для выбранного сеанса ещё не настроены места. Настройте схему зала перед обновлением билета.
                    </div>
                }
            </form>
        </div>
    }
}

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('updateTicketForm');
            if (!form) {
                return;
            }

            const seatButtons = Array.from(form.querySelectorAll('[data-seat-id]'));
            const selectedInput = document.getElementById('selected-seat-id');
            const submitButton = document.getElementById('updateTicketButton');
            const selectedInfo = document.getElementById('selected-info');

            const updateSummary = (row, seat) => {
                if (!selectedInfo) {
                    return;
                }

                selectedInfo.textContent = row && seat
                    ? `Выбрано место: ряд ${row}, место ${seat}`
                    : 'Место не выбрано';
            };

            const clearSelection = () => {
                seatButtons.forEach(btn => btn.classList.remove('selected'));
                if (selectedInput) {
                    selectedInput.value = '';
                }
                if (submitButton) {
                    submitButton.disabled = true;
                }
                updateSummary(null, null);
            };

            const applySelection = (button) => {
                if (!button || !selectedInput || !submitButton) {
                    return;
                }

                seatButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');

                selectedInput.value = button.dataset.seatId;
                submitButton.disabled = false;

                updateSummary(button.dataset.row, button.dataset.seat);
            };

            seatButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.disabled) {
                        return;
                    }
                    applySelection(button);
                });
            });

            const preselected = seatButtons.find(btn => btn.classList.contains('selected'));
            if (preselected) {
                applySelection(preselected);
            } else if (seatButtons.length === 0) {
                if (submitButton) {
                    submitButton.disabled = selectedInput ? !selectedInput.value : true;
                }
            } else {
                clearSelection();
            }
        });
    </script>
}
